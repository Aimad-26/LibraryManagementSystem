{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Emprunts | Librarian Dashboard</title>
    
    <link rel="stylesheet" href="{% static 'css/login.css' %}">
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}?v=3">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        .sidebar-link.active { background: rgba(255,255,255,0.1); font-weight: bold; }
        .stat-card { transition: transform 0.2s; border: none; }
        .stat-card:hover { transform: translateY(-5px); }
        .status-pill { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .status-active { background: #d1e7dd; color: #0f5132; }
        .status-overdue { background: #f8d7da; color: #842029; }
        .status-returned { background: #cfe2ff; color: #084298; }
    </style>
</head>
<body class="dashboard-page">

<div class="dashboard-layout">
    <aside class="dashboard-sidebar">
        <div class="sidebar-logo">
            <img src="{{ MEDIA_URL }}{{ logo_image }}" alt="Logo" class="logo-img">
        </div>
        <nav class="sidebar-nav">
            <p class="sidebar-section-label">LIBRARY</p>
            <a href="{% url 'dashboard' %}" class="sidebar-link">Dashboard</a>
            <a href="{% url 'books_list' %}" class="sidebar-link">üìö Manage Books</a>
            <a href="{% url 'emprunts_list' %}" class="sidebar-link active">üîÑ Loans / Emprunts</a>
            <a href="{% url 'users_list' %}" class="sidebar-link">üìñ Users Staff</a>
            <a href="{% url 'members_list' %}" class="sidebar-link">üë• Members</a>
        </nav>
    </aside>

    <main class="dashboard-main">
        <div class="dashboard-main-inner">
            <header class="topbar">
                <div class="topbar-search">
                    <span class="text-muted fw-light">Circulation / <strong>Gestion des Emprunts</strong></span>
                </div>
                <div class="topbar-user">
                    <span class="topbar-username">{{ username|default:"Librarian" }}</span>
                    <div class="topbar-avatar-btn">üë§</div>
                </div>
            </header>

            <section class="hero-banner" style="background: linear-gradient(135deg, #6366f1 0%, #3b82f6 100%);">
                <div class="hero-text-block">
                    <p class="hero-eyebrow">Circulation & Loans</p>
                    <h1 class="hero-title">üîÑ Suivi des Emprunts</h1>
                    <p class="hero-subtitle">G√©rez les flux de livres, les retours et les retards en temps r√©el.</p>
                </div>
                <div class="hero-actions">
                    <a href="{% url 'add_emprunt' %}" class="btn btn-white text-primary rounded-pill px-4 fw-bold shadow-sm">
                        <i class="ri-add-line me-1"></i> Nouvel Emprunt
                    </a>
                </div>
            </section>

            <div class="px-4 mt-n4">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="card stat-card shadow-sm rounded-4 border-start border-success border-4 p-3">
                            <small class="text-muted fw-bold">ACTIFS</small>
                            <h3 class="fw-bold mb-0 text-success">{{ stats.active }}</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card shadow-sm rounded-4 border-start border-danger border-4 p-3">
                            <small class="text-muted fw-bold">EN RETARD</small>
                            <h3 class="fw-bold mb-0 text-danger">{{ stats.overdue }}</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card shadow-sm rounded-4 border-start border-primary border-4 p-3">
                            <small class="text-muted fw-bold">RETOURN√âS</small>
                            <h3 class="fw-bold mb-0 text-primary">{{ stats.returned }}</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card shadow-sm rounded-4 border-start border-dark border-4 p-3">
                            <small class="text-muted fw-bold">TOTAL</small>
                            <h3 class="fw-bold mb-0 text-dark">{{ stats.total }}</h3>
                        </div>
                    </div>
                </div>
            </div>

            <section class="dashboard-section p-4">
                <div class="bg-white rounded-4 shadow-sm p-3 mb-4 d-flex align-items-center">
                    <i class="ri-search-line me-2 text-muted ms-2"></i>
                    <form method="GET" class="flex-grow-1">
                        <input type="text" name="search" value="{{ search_query }}" 
                               class="form-control border-0 shadow-none" 
                               placeholder="Rechercher un livre, un membre ou un email...">
                    </form>
                </div>

                <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr class="fs-xs fw-bold text-muted text-uppercase">
                                    <th class="ps-4 py-3">Livre</th>
                                    <th>Emprunteur</th>
                                    <th>Dates (Pr√™t / Retour)</th>
                                    <th>Statut</th>
                                    <th class="pe-4 text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for emprunt in emprunts %}
                                <tr>
                                    <td class="ps-4">
                                        <div class="fw-bold text-dark">{{ emprunt.book_title }}</div>
                                        <small class="text-muted">ID Emprunt: #{{ emprunt.id }}</small>
                                    </td>
                                    <td>
                                        <div class="fw-semibold">{{ emprunt.borrower_name }}</div>
                                        <div class="text-muted small">{{ emprunt.borrower_email }}</div>
                                    </td>
                                    <td>
                                        <div class="small">üìÖ {{ emprunt.borrow_date|date:"d/m/Y" }}</div>
                                        <div class="small text-primary">‚åõ {{ emprunt.return_date|date:"d/m/Y" }}</div>
                                    </td>
                                    <td>
                                        <span class="status-pill 
                                            {% if emprunt.status == 'active' %}status-active
                                            {% elif emprunt.status == 'overdue' %}status-overdue
                                            {% else %}status-returned{% endif %}">
                                            {{ emprunt.status }}
                                        </span>
                                    </td>
                                    <td class="pe-4 text-end">
                                        <div class="btn-group gap-1">
                                            {% if emprunt.status != 'returned' %}
                                            <a href="{% url 'return_emprunt' emprunt.id %}" 
                                               class="btn btn-sm btn-success rounded-pill px-3 fw-bold"
                                               onclick="return confirm('Confirmer le retour ?')">‚úì Retour</a>
                                            {% endif %}
                                            <a href="{% url 'edit_emprunt' emprunt.id %}" 
                                               class="btn btn-sm btn-outline-primary rounded-pill px-3">‚úèÔ∏è</a>
                                            <a href="{% url 'delete_emprunt' emprunt.id %}" 
                                               class="btn btn-sm btn-outline-danger rounded-pill px-3"
                                               onclick="return confirm('Supprimer cet enregistrement ?')">üóëÔ∏è</a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-5 text-muted">Aucun emprunt enregistr√©.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </main>
</div>

</body>
</html>